<% // views/partials/users-table.ejs (ИСПРАВЛЕННАЯ ВЕРСИЯ) %>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle adaptive-table">
    <thead>
      <tr>
        <% function sortLink(field, title) { 
          const params = new URLSearchParams(queryParams || {});
          const isCurrent = (queryParams?.sort === field);
          const nextOrder = (isCurrent && (queryParams?.order === 'asc')) ? 'desc' : 'asc';
          params.set('sort', field);
          params.set('order', nextOrder);
        %>
          <th scope="col" class="text-nowrap">
            <a href="/users-table?<%= params.toString() %>"
               hx-get="/users-table?<%= params.toString() %>"
               hx-include="#usersFilterForm"
               hx-target="#users-table-container"
               class="text-decoration-none text-dark fw-bold">
              <%= title %>
              <% if (isCurrent) { %>
                <i class="bi bi-arrow-<%= (queryParams?.order === 'asc') ? 'up' : 'down' %>-short"></i>
              <% } %>
            </a>
          </th>
        <% } %>

        <%- sortLink('id', 'ID') %>
        <th>Пользователь</th>
        <%- sortLink('active', 'Статус') %>
        <%- sortLink('total_downloads', 'Загрузок') %>
        <%- sortLink('premium_limit', 'Тариф') %>
        <%- sortLink('premium_until', 'Премиум до') %>
        <%- sortLink('created_at', 'Регистрация') %>
        <%- sortLink('last_active', 'Активность') %>
        <th>Смена тарифа</th>
        <th>Действия</th>
      </tr>
    </thead>

    <tbody>
      <% if (users && users.length > 0) { %>
        <% users.forEach(u => { 
            const plan =
              (u.premium_limit <= 5)     ? 'Free' :
              (u.premium_limit >= 10000) ? 'Unlim' :
              (u.premium_limit === 100)  ? 'Pro' :
              (u.premium_limit === 30)   ? 'Plus' : 'Other';

            const planBadge = {
              Free: 'bg-secondary',
              Plus: 'bg-info',
              Pro: 'bg-warning',
              Unlim: 'bg-primary',
              Other: 'bg-dark'
            }[plan] || 'bg-dark';

            const premiumUntilDate = u.premium_until ? new Date(u.premium_until) : null;
            const isExpired = (u.premium_limit > 5) && premiumUntilDate && (premiumUntilDate < new Date());
        %>
          <tr>
            <td data-label="ID">
              <a href="/user/<%= u.id %>" class="text-decoration-none"><%= u.id %></a>
            </td>

            <td data-label="Пользователь">
              <div class="fw-semibold"><%= u.first_name || 'Без имени' %></div>
              <div class="text-muted small"><%= u.username ? '@' + u.username : '' %></div>
            </td>

            <td data-label="Статус">
              <% if (u.active) { %>
                <span class="badge bg-success">Активен</span>
              <% } else { %>
                <span class="badge bg-danger">Заблокирован</span>
              <% } %>
            </td>

            <td data-label="Загрузок" class="text-center"><%= u.total_downloads || 0 %></td>

            <td data-label="Тариф" class="text-center">
              <span class="badge <%= planBadge %>"><%= plan %></span>
            </td>

            <td data-label="Премиум до" class="text-nowrap">
              <% if (u.premium_limit <= 5) { %>
                —
              <% } else { %>
                <span class="<%= isExpired ? 'text-danger fw-semibold' : '' %>">
                  <%= premiumUntilDate ? premiumUntilDate.toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '—' %>
                </span>
                <% if (isExpired) { %>
                  <span class="badge bg-danger ms-1">⌛ истёк</span>
                <% } %>
              <% } %>
            </td>

            <td data-label="Регистрация" class="text-nowrap">
              <%= u.created_at ? new Date(u.created_at).toLocaleDateString('ru-RU') : '-' %>
            </td>

            <td data-label="Активность" class="text-nowrap">
              <%= u.last_active
                  ? new Date(u.last_active).toLocaleString('ru-RU', {day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit', minute:'2-digit'})
                  : '-' %>
            </td>

            <td data-label="Смена тарифа">
              <form class="d-flex flex-wrap gap-2 align-items-center tariff-form" action="/set-tariff" method="post">
                <input type="hidden" name="userId" value="<%= u.id %>">
                <input type="hidden" name="applyMode" value="set">
                <select name="limit" class="form-select form-select-sm" style="min-width: 120px;">
                  <option value="5"     <%= u.premium_limit <= 5      ? 'selected' : '' %>>Free (5)</option>
                  <option value="30"    <%= u.premium_limit === 30    ? 'selected' : '' %>>Plus (30)</option>
                  <option value="100"   <%= u.premium_limit === 100   ? 'selected' : '' %>>Pro (100)</option>
                  <option value="10000" <%= u.premium_limit >= 10000  ? 'selected' : '' %>>Unlim</option>
                </select>
                <input type="number" name="days" class="form-control form-control-sm" value="30" style="width: 80px;" placeholder="Дни" min="1">
                <button type="submit" class="btn btn-sm btn-primary" title="Применить">✓</button>
              </form>
            </td>

            <td data-label="Действия" class="text-nowrap">
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">...</button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="/user/<%= u.id %>" target="_blank">Открыть профиль</a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="tg://user?id=<%= u.id %>">Открыть в Telegram</a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/reset-bonus" method="post">
                      <input type="hidden" name="userId" value="<%= u.id %>">
                      <button type="submit" class="dropdown-item" onclick="return confirm('Сбросить бонус?')">
                        Сбросить бонус
                      </button>
                    </form>
                  </li>
                  <li>
                    <form action="/reset-daily-limit" method="post">
                      <input type="hidden" name="userId" value="<%= u.id %>">
                      <button type="submit" class="dropdown-item" onclick="return confirm('Сбросить дневной лимит?')">
                        Сбросить дневной лимит
                      </button>
                    </form>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/user/set-status" method="POST">
                      <input type="hidden" name="userId" value="<%= u.id %>">
                      <% if (u.active) { %>
                        <input type="hidden" name="newStatus" value="false">
                        <button type="submit" class="dropdown-item text-danger"
                                onclick="return confirm('Заблокировать <%= u.first_name || u.id %>?')">
                          Заблокировать
                        </button>
                      <% } else { %>
                        <input type="hidden" name="newStatus" value="true">
                        <button type="submit" class="dropdown-item text-success">
                          Разблокировать
                        </button>
                      <% } %>
                    </form>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="10" class="text-center text-muted py-4">Пользователи не найдены.</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<% if (totalPages > 1) { 
     const curr = Number(queryParams?.page || 1);
%>
<nav>
  <ul class="pagination justify-content-center">
    <li class="page-item <%= (curr <= 1) ? 'disabled' : '' %>">
      <% if (curr > 1) { 
           const prevParams = new URLSearchParams(queryParams || {}); prevParams.set('page', curr - 1); %>
        <a class="page-link"
           href="/users-table?<%= prevParams.toString() %>"
           hx-get="/users-table?<%= prevParams.toString() %>"
           hx-include="#usersFilterForm"
           hx-target="#users-table-container"
        >&laquo;</a>
      <% } else { %>
        <span class="page-link">&laquo;</span>
      <% } %>
    </li>

    <% 
      const maxToShow = 7;
      let start = Math.max(1, curr - 3);
      let end = Math.min(totalPages, start + maxToShow - 1);
      if (end - start + 1 < maxToShow) start = Math.max(1, end - maxToShow + 1);

      for (let p = start; p <= end; p++) {
        const pParams = new URLSearchParams(queryParams || {}); pParams.set('page', p);
    %>
      <li class="page-item <%= (p === curr) ? 'active' : '' %>">
        <% if (p === curr) { %>
          <span class="page-link"><%= p %></span>
        <% } else { %>
          <a class="page-link"
             href="/users-table?<%= pParams.toString() %>"
             hx-get="/users-table?<%= pParams.toString() %>"
             hx-include="#usersFilterForm"
             hx-target="#users-table-container"
          ><%= p %></a>
        <% } %>
      </li>
    <% } %>

    <li class="page-item <%= (curr >= totalPages) ? 'disabled' : '' %>">
      <% if (curr < totalPages) { 
           const nextParams = new URLSearchParams(queryParams || {}); nextParams.set('page', curr + 1); %>
        <a class="page-link"
           href="/users-table?<%= nextParams.toString() %>"
           hx-get="/users-table?<%= nextParams.toString() %>"
           hx-include="#usersFilterForm"
           hx-target="#users-table-container"
        >&raquo;</a>
      <% } else { %>
        <span class="page-link">&raquo;</span>
      <% } %>
    </li>
  </ul>
</nav>
<% } %>