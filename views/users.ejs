<% // views/users.ejs %>

<h1 class="h3 mb-3">Пользователи (<%= totalUsers %>)</h1>

<!-- Фильтры -->
<form id="filterForm" class="row g-3 align-items-center mb-4">
  <div class="col-md-5">
    <label for="searchInput" class="visually-hidden">Поиск</label>
    <input type="text" class="form-control" id="searchInput" name="q" placeholder="Поиск по ID, имени, @username..." value="<%= searchQuery %>">
  </div>
  <div class="col-md-3">
    <label for="statusSelect" class="visually-hidden">Статус</label>
    <select class="form-select" id="statusSelect" name="status">
      <option value="" <%= statusFilter === '' ? 'selected' : '' %>>Все статусы</option>
      <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Только активные</option>
      <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Только неактивные</option>
    </select>
  </div>
  <div class="col-md-2">
    <label for="limitSelect" class="visually-hidden">На странице</label>
    <select class="form-select" id="limitSelect" name="limit">
      <option value="25" <%= limit == 25 ? 'selected' : '' %>>25 на странице</option>
      <option value="50" <%= limit == 50 ? 'selected' : '' %>>50 на странице</option>
      <option value="100" <%= limit == 100 ? 'selected' : '' %>>100 на странице</option>
    </select>
  </div>
</form>

<!-- Таблица пользователей (адаптивная) -->
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Пользователь</th>
        <th>Статус</th>
        <th>Всего загрузок</th>
        <th>Лимит</th>
        <th>Регистрация</th>
        <th>Последняя активность</th>
      </tr>
    </thead>
    <tbody>
      <% if (users.length > 0) { %>
        <% users.forEach(u => { %>
          <tr>
            <td><a href="/user/<%= u.id %>"><%= u.id %></a></td>
            <td>
              <div><%= u.first_name || 'Без имени' %></div>
              <div class="text-muted small"><%= u.username ? '@' + u.username : '' %></div>
            </td>
            <td>
              <% if (u.active) { %>
                <span class="badge bg-success">Активен</span>
              <% } else { %>
                <span class="badge bg-secondary">Неактивен</span>
              <% } %>
            </td>
            <td><%= u.total_downloads || 0 %></td>
            <td><%= u.premium_limit %></td>
            <td><%= new Date(u.created_at).toLocaleDateString('ru-RU') %></td>
            <td><%= u.last_active ? new Date(u.last_active).toLocaleString('ru-RU') : 'Никогда' %></td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="7" class="text-center text-muted">Пользователи не найдены.</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- Пагинация -->
<% if (totalPages > 1) { %>
<nav aria-label="Пагинация">
  <ul class="pagination justify-content-center">
    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
      <a class="page-link" href="#" data-page="1">«</a>
    </li>
    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
      <a class="page-link" href="#" data-page="<%= currentPage - 1 %>">‹</a>
    </li>
    
    <% 
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
    %>

    <% if (startPage > 1) { %>
      <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
    <% } %>

    <% for (let i = startPage; i <= endPage; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a class="page-link" href="#" data-page="<%= i %>"><%= i %></a>
      </li>
    <% } %>

    <% if (endPage < totalPages) { %>
      <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
    <% } %>

    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
      <a class="page-link" href="#" data-page="<%= currentPage + 1 %>">›</a>
    </li>
    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
      <a class="page-link" href="#" data-page="<%= totalPages %>">»</a>
    </li>
  </ul>
</nav>
<% } %>

<!-- Скрипт для "живого" поиска и фильтрации -->
<script>
  const form = document.getElementById('filterForm');
  const searchInput = document.getElementById('searchInput');
  const statusSelect = document.getElementById('statusSelect');
  const limitSelect = document.getElementById('limitSelect');
  let searchTimeout;

  function updateUrl(page = 1) {
    const params = new URLSearchParams(window.location.search);
    params.set('q', searchInput.value);
    params.set('status', statusSelect.value);
    params.set('limit', limitSelect.value);
    params.set('page', page);
    window.location.search = params.toString();
  }

  // Автоматический поиск при вводе текста с задержкой
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      updateUrl(1); // При новом поиске всегда переходим на первую страницу
    }, 500); // Задержка 500 мс
  });

  // Фильтрация при изменении селектов
  statusSelect.addEventListener('change', () => updateUrl(1));
  limitSelect.addEventListener('change', () => updateUrl(1));

  // Обработка кликов по пагинации
  document.querySelectorAll('.pagination a').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const page = e.target.dataset.page;
      if (page) {
        updateUrl(page);
      }
    });
  });

  // Отключаем стандартную отправку формы по Enter
  form.addEventListener('submit', (e) => e.preventDefault());
</script>