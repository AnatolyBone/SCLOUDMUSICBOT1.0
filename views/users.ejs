<% // views/users.ejs %>

<%- contentFor('body') %>

<h1 class="h3 mb-3">Пользователи (<%= totalUsers %>)</h1>

<!-- Фильтры -->
<form id="filterForm" class="row g-3 align-items-center mb-4">
  <div class="col-md-5 col-sm-12">
    <input type="text" class="form-control" id="searchInput" name="q" placeholder="Поиск по ID, имени, @username..." value="<%= searchQuery %>">
  </div>
  <div class="col-md-3 col-sm-6">
    <select class="form-select" id="statusSelect" name="status">
      <option value="" <%= statusFilter === '' ? 'selected' : '' %>>Все статусы</option>
      <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Только активные</option>
      <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Только неактивные</option>
    </select>
  </div>
  <div class="col-md-2 col-sm-6">
    <select class="form-select" id="limitSelect" name="limit">
      <option value="25" <%= limit == 25 ? 'selected' : '' %>>25 на странице</option>
      <option value="50" <%= limit == 50 ? 'selected' : '' %>>50 на странице</option>
      <option value="100" <%= limit == 100 ? 'selected' : '' %>>100 на странице</option>
    </select>
  </div>
</form>

<!-- Таблица пользователей -->
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Пользователь</th>
        <th>Статус</th>
        <th class="text-center">Загрузок</th>
        <th class="text-center">Лимит/День</th>
        <!-- <<< УЛУЧШЕНИЕ: Добавлена колонка с датой регистрации >>> -->
        <th>Дата регистрации</th>
        <th>Смена тарифа</th>
      </tr>
    </thead>
    <tbody>
      <% if (users && users.length > 0) { %>
        <% users.forEach(u => { %>
          <tr>
            <td><a href="/user/<%= u.id %>"><%= u.id %></a></td>
            <td>
              <div><%= u.first_name || 'Без имени' %></div>
              <div class="text-muted small"><%= u.username ? '@' + u.username : '' %></div>
            </td>
            <td>
              <% if (u.active) { %>
                <span class="badge bg-success">Активен</span>
              <% } else { %>
                <span class="badge bg-secondary">Неактивен</span>
              <% } %>
            </td>
            <td class="text-center"><%= u.total_downloads || 0 %></td>
            <td class="text-center">
                <span class="badge bg-info"><%= u.premium_limit %></span>
            </td>
            <!-- <<< УЛУЧШЕНИЕ: Выводим дату регистрации >>> -->
            <td><%= u.created_at ? new Date(u.created_at).toLocaleDateString('ru-RU') : '-' %></td>
            <td>
              <form class="d-flex flex-wrap gap-2" action="/set-tariff" method="post">
                <input type="hidden" name="userId" value="<%= u.id %>">
                <select name="limit" class="form-select form-select-sm" style="min-width: 120px;">
                  <option value="5" <%= u.premium_limit == 5 ? 'selected' : '' %>>Free (5)</option>
                  <option value="30" <%= u.premium_limit == 30 ? 'selected' : '' %>>Plus (30)</option>
                  <option value="100" <%= u.premium_limit == 100 ? 'selected' : '' %>>Pro (100)</option>
                  <option value="10000" <%= u.premium_limit >= 10000 ? 'selected' : '' %>>Unlim</option>
                </select>
                <input type="number" name="days" class="form-control form-control-sm" value="30" style="width: 80px;" placeholder="Дни">
                <button type="submit" class="btn btn-sm btn-primary">✓</button>
              </form>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <!-- УЛУЧШЕНИЕ: Увеличили colspan на 1 -->
          <td colspan="7" class="text-center text-muted py-4">Пользователи не найдены.</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- Пагинация -->
<% if (totalPages > 1) { %>
<nav aria-label="Пагинация">
  <ul class="pagination justify-content-center">
    <!-- ... (код пагинации без изменений) ... -->
  </ul>
</nav>
<% } %>

<!-- Скрипт для "живого" поиска и фильтрации -->
<script>
  // ... (весь скрипт без изменений)
</script>