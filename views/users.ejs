<% // views/users.ejs (С КНОПКОЙ ЭКСПОРТА) %>

<%- contentFor('body') %>

<!-- Стили (без изменений) -->
<style>
  /* ... */
</style>

<!-- Подключаем HTMX (если еще не подключен в главном шаблоне) -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<h1 class="h3 mb-3">Пользователи (<%= totalUsers %>)</h1>

<!-- Фильтры с правильными атрибутами HTMX -->
<form id="usersFilterForm" class="row g-3 align-items-center mb-4" 
      hx-get="/users-table" 
      hx-target="#users-table-container" 
      hx-trigger="keyup changed delay:300ms from:#searchInput, change from:.form-select"
      hx-swap="innerHTML">
  <div class="col-md-4 col-sm-12">
    <input type="text" class="form-control" id="searchInput" name="q" placeholder="Поиск по ID, имени, @username..." value="<%= searchQuery %>">
  </div>
  <div class="col-md-3 col-sm-6">
    <select class="form-select" name="status">
      <option value="" <%= statusFilter === '' ? 'selected' : '' %>>Все статусы</option>
      <option value="active" <%= statusFilter === 'active' ? 'selected' : '' %>>Активные</option>
      <option value="inactive" <%= statusFilter === 'inactive' ? 'selected' : '' %>>Неактивные</option>
    </select>
  </div>
  <div class="col-md-2 col-sm-6">
    <select class="form-select" name="limit">
      <option value="25" <%= limit == 25 ? 'selected' : '' %>>25</option>
      <option value="50" <%= limit == 50 ? 'selected' : '' %>>50</option>
      <option value="100" <%= limit == 100 ? 'selected' : '' %>>100</option>
    </select>
  </div>
  
  <!-- ======================= НОВАЯ КНОПКА ЭКСПОРТА ======================= -->
  <div class="col-md-3 col-sm-12">
    <a id="export-link" href="/users/export.csv" class="btn btn-outline-success w-100">
      <i class="bi bi-file-earmark-spreadsheet"></i> Экспорт в CSV
    </a>
  </div>
  <!-- ===================================================================== -->

</form>

<!-- Контейнер для "живой" перезагрузки -->
<div id="users-table-container">
  <%- include('partials/users-table', { users, totalPages, currentPage, queryParams }) %>
</div>

<!-- ======================= НОВЫЙ СКРИПТ ДЛЯ КНОПКИ ======================= -->
<script>
  function updateExportLink() {
    // Находим текущие значения фильтров
    const form = document.getElementById('usersFilterForm');
    if (!form) return;
    
    const q = form.querySelector('input[name=q]').value;
    const status = form.querySelector('select[name=status]').value;
    
    // Находим нашу ссылку
    const exportLink = document.getElementById('export-link');
    if (!exportLink) return;

    // Собираем параметры для URL
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (status) params.set('status', status);
    
    // Обновляем атрибут href у ссылки
    exportLink.href = `/users/export.csv?${params.toString()}`;
  }

  // Обновляем ссылку сразу при загрузке страницы
  document.addEventListener('DOMContentLoaded', updateExportLink);
  
  // И обновляем ее каждый раз, когда меняется фильтр (после того, как HTMX отработает)
  document.body.addEventListener('htmx:afterSettle', function(evt) {
    // Проверяем, что событие пришло от нашей формы
    if (evt.target.id === 'usersFilterForm') {
      updateExportLink();
    }
  });
</script>
<!-- =================================================================== -->