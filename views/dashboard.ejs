<% // views/dashboard.ejs %>

<%- contentFor('styles') %>
<style>
  .card-metric { transition: transform 0.2s; }
  .card-metric:hover { transform: translateY(-5px); }
  .chart-container { position: relative; width: 100%; }
  .bg-light-warning { background-color: #fff3cd !important; }
</style>

<%- contentFor('body') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">–î–∞—à–±–æ—Ä–¥</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <form class="d-flex gap-2">
      <select name="period" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="7" <%= period == '7' ? 'selected' : '' %>>–ó–∞ 7 –¥–Ω–µ–π</option>
        <option value="30" <%= period == '30' ? 'selected' : '' %>>–ó–∞ 30 –¥–Ω–µ–π</option>
        <option value="90" <%= period == '90' ? 'selected' : '' %>>–ó–∞ 90 –¥–Ω–µ–π</option>
      </select>
    </form>
  </div>
</div>

<!-- –í–µ—Ä—Ö–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -->
<div class="row g-4 mb-4">
  <div class="col-xl-3 col-md-6"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5><p class="h2 mb-0"><%= stats.total_users || '0' %></p></div></div></div>
  <div class="col-xl-3 col-md-6"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</h5><p class="h2 mb-0"><%= stats.active_today || '0' %></p></div></div></div>
  <div class="col-xl-3 col-md-6"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–ó–∞–≥—Ä—É–∑–æ–∫ (–≤—Å–µ–≥–æ)</h5><p class="h2 mb-0"><%= stats.total_downloads || '0' %></p></div></div></div>
  <div class="col-xl-3 col-md-6"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–¢—Ä–µ–∫–æ–≤ –≤ –∫—ç—à–µ</h5><p class="h2 mb-0"><%= stats.cachedTracksCount || '0' %></p></div></div></div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ -->
<div class="row g-4 mb-4">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º</div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>–û—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–æ–∫</span><span class="badge bg-primary rounded-pill"><%= stats.queueWaiting || 0 %> –≤ –æ–∂. / <%= stats.queueActive || 0 %> –≤ —Ä–∞–±.</span></li>
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>–ö–∞–Ω–∞–ª-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ</span><% if (locals.storageStatus && storageStatus.available) { %><span class="badge bg-success">–î–æ—Å—Ç—É–ø–µ–Ω</span><% } else { %><span class="badge bg-danger" data-bs-toggle="tooltip" title="<%= (locals.storageStatus && storageStatus.error) ? storageStatus.error : 'ID –Ω–µ —É–∫–∞–∑–∞–Ω' %>">–û—à–∏–±–∫–∞</span><% } %></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º</div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üÜì Free</span><span class="fw-bold"><%= stats.usersByTariff.Free || 0 %></span></li>
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üéØ Plus</span><span class="fw-bold"><%= stats.usersByTariff.Plus || 0 %></span></li>
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üí™ Pro</span><span class="fw-bold"><%= stats.usersByTariff.Pro || 0 %></span></li>
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üíé Unlimited</span><span class="fw-bold"><%= stats.usersByTariff.Unlimited || 0 %></span></li>
          <% if (stats.usersByTariff.Other && stats.usersByTariff.Other > 0) { %>
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-light-warning">
              <span class="fw-bold">‚öôÔ∏è –î—Ä—É–≥–∏–µ (—Å—Ç–∞—Ä—ã–µ)</span>
              <span class="fw-bold"><%= stats.usersByTariff.Other %></span>
            </li>
          <% } %>
        </ul>
      </div>
      <% if (stats.usersByTariff.Other && stats.usersByTariff.Other > 0) { %>
        <div class="card-footer text-center">
            <form method="POST" action="/admin/reset-other-tariffs" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Å–±—Ä–æ—Å–∏—Ç <%= stats.usersByTariff.Other %> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Ç–∞—Ä–∏—Ñ Free. –û—Ç–º–µ–Ω–∏—Ç—å –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.')">
                <button type="submit" class="btn btn-sm btn-outline-danger">–°–±—Ä–æ—Å–∏—Ç—å "–¥—Ä—É–≥–∏–µ" —Ç–∞—Ä–∏—Ñ—ã –Ω–∞ Free</button>
            </form>
        </div>
      <% } %>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">–¢–æ–ø-5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞</div>
      <div class="card-body">
         <% if (stats.topSources && stats.topSources.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% stats.topSources.forEach(source => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <span class="text-truncate" title="<%= source.referral_source %>"><%= source.referral_source %></span>
                <span class="badge bg-secondary rounded-pill"><%= source.count %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted text-center my-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.</p>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- –ì–†–ê–§–ò–ö–ò -->
<div class="card shadow-sm mb-4">
  <div class="card-header">–î–∏–Ω–∞–º–∏–∫–∞ –º–µ—Ç—Ä–∏–∫ (–∑–∞ <%= period %> –¥–Ω–µ–π)</div>
  <div class="card-body chart-container" style="height: 350px;">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º</div>
      <div class="card-body d-flex justify-content-center align-items-center" style="height: 300px;">
          <canvas id="tariffsChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ (–∑–∞–≥—Ä—É–∑–∫–∏)</div>
      <div class="card-body chart-container" style="height: 300px;">
          <canvas id="weekdayChart"></canvas>
      </div>
    </div>
  </div>
</div>

<%- contentFor('scripts') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    new bootstrap.Tooltip(document.body, { selector: "[data-bs-toggle='tooltip']" });

    function drawChart(canvasId, chartData, chartType, options = {}) {
        const ctx = document.getElementById(canvasId);
        if (ctx && chartData && chartData.labels && chartData.labels.length > 0) {
            new Chart(ctx, { type: chartType, data: chartData, options: options });
        }
    }

    const commonLineBarOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } };
    
    drawChart('mainChart', <%- JSON.stringify(locals.chartDataCombined || {}) %>, 'line', commonLineBarOptions);
    
    drawChart('tariffsChart', <%- JSON.stringify(locals.chartDataTariffs || {}) %>, 'doughnut', { 
        responsive: true, 
        maintainAspectRatio: true,
        plugins: { legend: { position: 'top' } } 
    });
    
    drawChart('weekdayChart', <%- JSON.stringify(locals.chartDataWeekday || {}) %>, 'bar', { 
        ...commonLineBarOptions, 
        plugins: { legend: { display: false } } 
    });
  });
</script>