<% // views/dashboard.ejs %>

<%- contentFor('styles') %>
<style>
  .card-metric { transition: transform 0.2s; }
  .card-metric:hover { transform: translateY(-5px); }
  .chart-container { position: relative; width: 100%; }
  .bg-light-warning { background-color: #fff3cd !important; }
  .bg-light-success { background-color: #d1e7dd !important; }
</style>

<%- contentFor('body') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">–î–∞—à–±–æ—Ä–¥</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <form id="periodForm" class="d-flex align-items-center flex-wrap gap-2">
        <input type="hidden" name="startDate" id="startDateInput">
        <input type="hidden" name="endDate" id="endDateInput">
        <div class="btn-group btn-group-sm">
            <a href="#" class="btn btn-outline-secondary" data-days="7">7 –¥–Ω–µ–π</a>
            <a href="#" class="btn btn-outline-secondary" data-days="30">30 –¥–Ω–µ–π</a>
            <a href="#" class="btn btn-outline-secondary" data-days="90">90 –¥–Ω–µ–π</a>
        </div>
        <input type="text" id="date-range-picker" class="form-control form-control-sm" style="width: 220px; text-align: center;">
        <button type="submit" class="btn btn-sm btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </form>
  </div>
</div> <!-- –∑–∞–∫—Ä—ã–≤–∞–µ–º —à–∞–ø–∫—É —Å border-bottom -->
<% if (typeof resetOthers !== 'undefined' && resetOthers !== null) { %>
<% if (resetOthers === 'err') { %>
<div class="alert alert-danger mt-2">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å ¬´–î—Ä—É–≥–∏–µ (—Å—Ç–∞—Ä—ã–µ)¬ª.</div>
<% } else { %>
<div class="alert alert-success mt-2">–°–±—Ä–æ—à–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <b><%= resetOthers %></b>.</div>
<% } %>
<% } %>

<!-- –í–µ—Ä—Ö–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -->
<div class="row row-cols-1 row-cols-md-3 row-cols-lg-5 g-4 mb-4">
  <div class="col"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–í—Å–µ–≥–æ —é–∑–µ—Ä–æ–≤</h5><p class="h2 mb-0"><%= stats.total_users || '0' %></p></div></div></div>
  <div class="col"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è</h5><p class="h2 mb-0"><%= stats.active_today || '0' %></p></div></div></div>
  <div class="col"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–ó–∞–≥—Ä—É–∑–æ–∫ (–≤—Å–µ–≥–æ)</h5><p class="h2 mb-0"><%= stats.total_downloads || '0' %></p></div></div></div>
  
  <!-- =====> –ù–û–í–ê–Ø –ö–ê–†–¢–û–ß–ö–ê: –ü–†–ò–ì–õ–ê–®–ï–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò <===== -->
  <div class="col"><div class="card card-metric shadow-sm text-center h-100 bg-light-success"><div class="card-body"><h5 class="card-title text-muted">–ü—Ä–∏—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ</h5><p class="h2 mb-0"><%= stats.totalReferred || '0' %></p></div></div></div>
  
  <div class="col"><div class="card card-metric shadow-sm text-center h-100"><div class="card-body"><h5 class="card-title text-muted">–¢—Ä–µ–∫–æ–≤ –≤ –∫—ç—à–µ</h5><p class="h2 mb-0"><%= stats.cachedTracksCount || '0' %></p></div></div></div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ -->
<div class="row g-4 mb-4">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º</div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>–û—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–æ–∫</span><span class="badge bg-primary rounded-pill"><%= stats.queueWaiting || 0 %> –≤ –æ–∂. / <%= stats.queueActive || 0 %> –≤ —Ä–∞–±.</span></li>
          <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>–ö–∞–Ω–∞–ª-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ</span><% if (locals.storageStatus && storageStatus.available) { %><span class="badge bg-success">–î–æ—Å—Ç—É–ø–µ–Ω</span><% } else { %><span class="badge bg-danger" data-bs-toggle="tooltip" title="<%= (locals.storageStatus && storageStatus.error) ? storageStatus.error : 'ID –Ω–µ —É–∫–∞–∑–∞–Ω' %>">–û—à–∏–±–∫–∞</span><% } %></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º</div>
      <div class="card-body">
        <% const othersCount =
  Number(stats?.usersByTariff?.Other ?? 0) ||
  Number(stats?.usersByTariff?.other ?? 0) ||
  Number(stats?.usersByTariff?.Legacy ?? 0) ||
  0;
%>

<ul class="list-group list-group-flush">
  <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üÜì Free</span><span class="fw-bold"><%= (stats.usersByTariff && stats.usersByTariff.Free) || 0 %></span></li>
  <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üéØ Plus</span><span class="fw-bold"><%= (stats.usersByTariff && stats.usersByTariff.Plus) || 0 %></span></li>
  <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üí™ Pro</span><span class="fw-bold"><%= (stats.usersByTariff && stats.usersByTariff.Pro) || 0 %></span></li>
  <li class="list-group-item d-flex justify-content-between align-items-center px-0"><span>üíé Unlimited</span><span class="fw-bold"><%= (stats.usersByTariff && stats.usersByTariff.Unlimited) || 0 %></span></li>

  <% if (othersCount > 0) { %>
    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-light-warning">
      <span class="fw-bold">‚öôÔ∏è –î—Ä—É–≥–∏–µ (—Å—Ç–∞—Ä—ã–µ)</span>
      <span class="fw-bold"><%= othersCount %></span>
    </li>

    <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
    <li class="list-group-item px-0">
      <form method="post" action="/tariffs/reset-others" class="mt-2">
        <button type="submit" class="btn btn-sm btn-warning">
          –°–±—Ä–æ—Å–∏—Ç—å ¬´–î—Ä—É–≥–∏–µ (—Å—Ç–∞—Ä—ã–µ)¬ª –¥–æ Free (5)
        </button>
      </form>
    </li>
  <% } %>
</ul>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">–¢–æ–ø-5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞</div>
      <div class="card-body">
         <% if (stats.topSources && stats.topSources.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% stats.topSources.forEach(source => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <span class="text-truncate" title="<%= source.referral_source %>"><%= source.referral_source %></span>
                <span class="badge bg-secondary rounded-pill"><%= source.count %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted text-center my-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º.</p>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- –ì–†–ê–§–ò–ö–ò -->
<div class="card shadow-sm mb-4">
  <div class="card-header">–î–∏–Ω–∞–º–∏–∫–∞ –º–µ—Ç—Ä–∏–∫</div>
  <div class="card-body chart-container" style="height: 350px;">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º</div>
      <div class="card-body d-flex justify-content-center align-items-center" style="height: 300px;">
          <canvas id="tariffsChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</div>
      <div class="card-body chart-container" style="height: 300px;">
          <canvas id="weekdayChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm my-4">
  <div class="card-header">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)</div>
  <div class="card-body chart-container" style="height: 300px;">
    <canvas id="hourlyChart"></canvas>
  </div>
</div>

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
<div class="row g-4 mb-4">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">üéµ –¢–æ–ø-10 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤</div>
      <div class="card-body">
        <% if (topTracks && topTracks.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% topTracks.forEach((track, index) => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div class="text-truncate">
                  <span class="text-muted"><%= index + 1 %>.</span> <%= track.track_title %>
                </div>
                <span class="badge bg-primary rounded-pill"><%= track.count %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted text-center my-4">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö.</p>
        <% } %>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">üèÜ –¢–æ–ø-10 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      <div class="card-body">
        <% if (topUsers && topUsers.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% topUsers.forEach((user, index) => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div class="text-truncate">
                  <span class="text-muted"><%= index + 1 %>.</span>
                  <a href="/user/<%= user.id %>" class="text-decoration-none"><%= user.first_name || 'ID: ' + user.id %></a>
                  <% if (user.username) { %><small class="text-muted">@<%= user.username %></small><% } %>
                </div>
                <span class="badge bg-success rounded-pill"><%= user.total_downloads %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted text-center my-4">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö.</p>
        <% } %>
      </div>
    </div>
  </div>

  <!-- =====> –ù–û–í–´–ô –ë–õ–û–ö: –¢–û–ü –†–ï–§–û–í–û–î–û–í <===== -->
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">üôã‚Äç‚ôÇÔ∏è –¢–æ–ø-5 —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤</div>
      <div class="card-body">
        <% if (stats.topReferrers && stats.topReferrers.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% stats.topReferrers.forEach((user, index) => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div class="text-truncate">
                  <span class="text-muted"><%= index + 1 %>.</span>
                  <a href="/user/<%= user.referrer_id %>" class="text-decoration-none"><%= user.first_name || 'ID: ' + user.referrer_id %></a>
                </div>
                <span class="badge bg-info rounded-pill"><%= user.referral_count %> –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted text-center my-4">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–∏–∫–æ–≥–æ –Ω–µ –ø—Ä–∏–≥–ª–∞—Å–∏–ª.</p>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- contentFor('scripts') %>
<script>
  window.addEventListener('load', function() {
    setTimeout(() => {
      try { new bootstrap.Tooltip(document.body, { selector: "[data-bs-toggle='tooltip']" }); } catch(e) {}

      if (typeof Chart === 'undefined' || typeof Litepicker === 'undefined') {
        console.error('–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Chart.js –∏–ª–∏ Litepicker) –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
        return;
      }

      const form = document.getElementById('periodForm');
      const startDateInput = document.getElementById('startDateInput');
      const endDateInput = document.getElementById('endDateInput');
      const dateRangePickerElement = document.getElementById('date-range-picker');
      
      const picker = new Litepicker({
          element: dateRangePickerElement,
          singleMode: false,
          format: 'DD.MM.YYYY',
          startDate: '<%= startDate || new Date(new Date().setDate(new Date().getDate() - 29)).toISOString().slice(0, 10) %>',
          endDate: '<%= endDate || new Date().toISOString().slice(0, 10) %>',
          setup: (picker) => {
              picker.on('selected', (date1, date2) => {
                  if (date1 && date2) {
                    startDateInput.value = date1.format('YYYY-MM-DD');
                    endDateInput.value = date2.format('YYYY-MM-DD');
                  }
              });
          }
      });
      
      form.querySelectorAll('.btn-group .btn').forEach(button => {
        button.addEventListener('click', (event) => {
            event.preventDefault();
            const days = parseInt(event.target.dataset.days, 10);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - (days - 1));
            
            picker.setDateRange(startDate, endDate, true);
            startDateInput.value = startDate.toISOString().slice(0, 10);
            endDateInput.value = endDate.toISOString().slice(0, 10);

            form.submit();
        });
      });
      
      if (picker.getStartDate() && picker.getEndDate()) {
          startDateInput.value = picker.getStartDate().format('YYYY-MM-DD');
          endDateInput.value = picker.getEndDate().format('YYYY-MM-DD');
      }

      function drawChart(canvasId, chartData, chartType, options = {}) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;

          if (chartData && chartData.labels && chartData.labels.length > 0 && chartData.datasets) {
              try {
                  if (Chart.getChart(canvas)) {
                      Chart.getChart(canvas).destroy();
                  }
                  new Chart(canvas.getContext('2d'), { type: chartType, data: chartData, options: options });
              } catch(e) {
                  canvas.parentElement.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100 text-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞.</div>`;
              }
          } else {
              canvas.parentElement.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100 text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>`;
          }
      }

      const commonLineBarOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } };
      
      drawChart('mainChart', <%- JSON.stringify(chartDataCombined) %>, 'line', commonLineBarOptions);
      drawChart('tariffsChart', <%- JSON.stringify(chartDataTariffs) %>, 'doughnut', { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top' } } });
      drawChart('weekdayChart', <%- JSON.stringify(chartDataWeekday) %>, 'bar', { ...commonLineBarOptions, plugins: { legend: { display: false } } });
      drawChart('hourlyChart', <%- JSON.stringify(chartDataHourly) %>, 'bar', { ...commonLineBarOptions, plugins: { legend: { display: false } } });
      
    }, 100);
  });
</script>