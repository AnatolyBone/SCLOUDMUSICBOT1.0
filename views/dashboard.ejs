<%# views/dashboard.ejs (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) %>

<%# === –•–µ–ª–ø–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ === %>
<% 
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
  const escapeHtml = (str) => {
    if (str === undefined || str === null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª (1234 -> "1 234")
  const formatNumber = (num) => {
    if (num === undefined || num === null) return '0';
    return Number(num).toLocaleString('ru-RU');
  };
%>

<%# === –°—Ç–∏–ª–∏, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ === %>
<%- contentFor('styles') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" integrity="sha256-vT2a22r2ouAL2ltm6mBa7s1j4NOsE12WkQ2xP29S/4o=" crossorigin="anonymous"/>
<style>
  .stats-grid .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .stats-grid .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  }
  
  .chart-container {
    position: relative;
    width: 100%;
    min-height: 300px;
  }
  
  /* –¶–≤–µ—Ç–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
  .bg-light-success { background-color: rgba(25, 135, 84, 0.1) !important; }
  .bg-light-warning { background-color: rgba(255, 193, 7, 0.15) !important; }
  .bg-light-danger { background-color: rgba(220, 53, 69, 0.1) !important; }

  /* –°–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ */
  .card-tariffs .list-group-item {
    padding-left: 0;
    padding-right: 0;
  }

  /* –°–ø–∏—Å–∫–∏ "—Ç–æ–ø–æ–≤" */
  .top-list .badge {
    min-width: 40px;
    text-align: center;
  }
</style>

<%# === –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç === %>
<%- contentFor('body') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">üìä –î–∞—à–±–æ—Ä–¥</h1>
  <form id="periodForm" class="d-flex align-items-center flex-wrap gap-2">
    <input type="hidden" name="startDate" id="startDateInput">
    <input type="hidden" name="endDate" id="endDateInput">
    <div class="btn-group btn-group-sm" role="group"><a href="#" class="btn btn-outline-secondary" data-days="7">7 –¥–Ω–µ–π</a><a href="#" class="btn btn-outline-secondary active" data-days="30">30 –¥–Ω–µ–π</a><a href="#" class="btn btn-outline-secondary" data-days="90">90 –¥–Ω–µ–π</a></div>
    <input type="text" id="date-range-picker" class="form-control form-control-sm" style="width: 220px; text-align: center;">
    <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å</button>
  </form>
</div>

<%# === –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è === %>
<% 
  const alerts = [];
  if (locals.resetOthers) {
    const message = locals.resetOthers === 'err' 
      ? '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å "–î—Ä—É–≥–∏–µ" —Ç–∞—Ä–∏—Ñ—ã' 
      : `–°–±—Ä–æ—à–µ–Ω–æ "–î—Ä—É–≥–∏—Ö" —Ç–∞—Ä–∏—Ñ–æ–≤: <b>${escapeHtml(locals.resetOthers)}</b>`;
    alerts.push({ type: locals.resetOthers === 'err' ? 'danger' : 'success', message });
  }
  if (locals.resetExpired) {
    const message = locals.resetExpired === 'err' 
      ? '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏' 
      : `–°–±—Ä–æ—à–µ–Ω–æ –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫: <b>${escapeHtml(locals.resetExpired)}</b>`;
    alerts.push({ type: locals.resetExpired === 'err' ? 'danger' : 'success', message });
  }
%>
<% alerts.forEach(alert => { %>
  <div class="alert alert-<%= alert.type %> alert-dismissible fade show" role="alert" data-autohide="5000">
    <%- alert.message %><button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% }); %>

<%# === –í–µ—Ä—Ö–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ === %>
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-5 g-4 mb-4 stats-grid">
  <% 
    const metrics = [
      { label: '–í—Å–µ–≥–æ —é–∑–µ—Ä–æ–≤', value: stats.total_users, icon: 'bi-people-fill' },
      { label: '–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è', value: stats.active_today, icon: 'bi-activity' },
      { label: '–ó–∞–≥—Ä—É–∑–æ–∫ (–≤—Å–µ–≥–æ)', value: stats.total_downloads, icon: 'bi-download' },
      { label: '–ü—Ä–∏—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ', value: stats.totalReferred, icon: 'bi-share-fill', bg: 'bg-light-success' },
      { label: '–¢—Ä–µ–∫–æ–≤ –≤ –∫—ç—à–µ', value: stats.cachedTracksCount, icon: 'bi-hdd-stack-fill' }
    ];
  %>
  <% metrics.forEach(m => { %>
    <div class="col">
      <div class="card shadow-sm text-center h-100 <%= m.bg || '' %>">
        <div class="card-body">
          <i class="bi <%= m.icon %> h3 text-muted mb-2"></i>
          <p class="h2 mb-0"><%= formatNumber(m.value) %></p>
          <h5 class="card-title text-muted small mt-1"><%= m.label %></h5>
        </div>
      </div>
    </div>
  <% }); %>
</div>

<%# === –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ === %>
<div class="row g-4 mb-4">
  <%# –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º %>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold"><i class="bi bi-hdd-network me-2"></i>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º</div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span>–û—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–æ–∫</span>
            <span class="badge bg-primary rounded-pill" data-bs-toggle="tooltip" title="–í –æ–∂–∏–¥–∞–Ω–∏–∏ / –í —Ä–∞–±–æ—Ç–µ">
              <%= formatNumber(stats.queueWaiting) %> / <%= formatNumber(stats.queueActive) %>
            </span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span>–ö–∞–Ω–∞–ª-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ</span>
            <% if (storageStatus?.available) { %>
              <span class="badge bg-success">‚úì –î–æ—Å—Ç—É–ø–µ–Ω</span>
            <% } else { %>
              <span class="badge bg-danger" 
                    data-bs-toggle="tooltip" 
                    title="<%= escapeHtml(storageStatus?.error || 'ID –Ω–µ —É–∫–∞–∑–∞–Ω') %>">
                ‚úó –û—à–∏–±–∫–∞
              </span>
            <% } %>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <%# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º %>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100 card-tariffs">
      <div class="card-header fw-semibold"><i class="bi bi-pie-chart-fill me-2"></i>–¢–∞—Ä–∏—Ñ—ã</div>
      <div class="card-body">
        <% 
          const tariffs = [
            { label: 'üÜì Free', value: stats.usersByTariff?.Free },
            { label: 'üéØ Plus', value: stats.usersByTariff?.Plus },
            { label: 'üí™ Pro', value: stats.usersByTariff?.Pro },
            { label: 'üíé Unlimited', value: stats.usersByTariff?.Unlimited }
          ];
          const othersCount = Number(stats?.usersByTariff?.Other ?? 0);
          const expiredCountSafe = Number(expiredCount ?? 0);
        %>
        <ul class="list-group list-group-flush">
          <% tariffs.forEach(t => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><%- t.label %></span>
              <span class="fw-bold"><%= formatNumber(t.value) %></span>
            </li>
          <% }); %>
          
          <li class="list-group-item d-flex justify-content-between align-items-center <%= othersCount > 0 ? 'bg-light-warning' : '' %>">
            <span class="fw-semibold">‚öôÔ∏è –î—Ä—É–≥–∏–µ (—Å—Ç–∞—Ä—ã–µ)</span>
            <span class="fw-bold"><%= formatNumber(othersCount) %></span>
          </li>
          
          <li class="list-group-item d-flex justify-content-between align-items-center <%= expiredCountSafe > 0 ? 'bg-light-danger' : '' %>">
            <span class="fw-semibold">‚åõ –ò—Å—Ç—ë–∫—à–∏–µ (–Ω–µ Free)</span>
            <span class="fw-bold"><%= formatNumber(expiredCountSafe) %></span>
          </li>
        </ul>

        <div class="d-flex flex-column gap-2 mt-3">
          <% if (othersCount > 0) { %>
            <form method="post" action="/tariffs/reset-others">
              <button type="submit" 
                      class="btn btn-sm btn-warning w-100" 
                      data-confirm="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ '–î—Ä—É–≥–∏–µ' —Ç–∞—Ä–∏—Ñ—ã –¥–æ Free?">
                –°–±—Ä–æ—Å–∏—Ç—å ¬´–î—Ä—É–≥–∏–µ¬ª
              </button>
            </form>
          <% } %>
          
          <% if (expiredCountSafe > 0) { %>
            <form method="post" action="/tariffs/reset-expired">
              <button type="submit" 
                      class="btn btn-sm btn-outline-danger w-100" 
                      data-confirm="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏—Å—Ç—ë–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–æ Free?">
                –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ
              </button>
            </form>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <%# –¢–æ–ø-5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞ %>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100 top-list">
      <div class="card-header fw-semibold"><i class="bi bi-signpost-split-fill me-2"></i>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</div>
      <div class="card-body">
        <% if (stats.topSources?.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% stats.topSources.forEach(source => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span class="text-truncate" title="<%- escapeHtml(source.referral_source) %>">
                  <%- escapeHtml(source.referral_source) %>
                </span>
                <span class="badge bg-secondary rounded-pill"><%= formatNumber(source.count) %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="text-muted text-center my-4">
            <i class="bi bi-inbox fs-3 opacity-25"></i>
            <p class="mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%# === –ì–†–ê–§–ò–ö–ò === %>
<div class="card shadow-sm mb-4">
  <div class="card-header fw-semibold"><i class="bi bi-graph-up me-2"></i>–î–∏–Ω–∞–º–∏–∫–∞ –º–µ—Ç—Ä–∏–∫</div>
  <div class="card-body chart-container">
    <div class="spinner d-none" id="mainChartSpinner"></div>
    <canvas id="mainChart"></canvas>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold"><i class="bi bi-pie-chart-fill me-2"></i>–¢–∞—Ä–∏—Ñ—ã</div>
      <div class="card-body d-flex justify-content-center align-items-center chart-container">
        <canvas id="tariffsChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold"><i class="bi bi-bar-chart-line-fill me-2"></i>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</div>
      <div class="card-body chart-container">
        <canvas id="weekdayChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm my-4">
  <div class="card-header fw-semibold"><i class="bi bi-clock-history me-2"></i>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º (–∑–∞ 7 –¥–Ω–µ–π)</div>
  <div class="card-body chart-container">
    <canvas id="hourlyChart"></canvas>
  </div>
</div>

<%# === –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ === %>
<div class="row g-4 mb-4">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100 top-list">
      <div class="card-header fw-semibold"><i class="bi bi-music-note-list me-2"></i>–¢–æ–ø-10 —Ç—Ä–µ–∫–æ–≤</div>
      <div class="card-body">
        <% if (topTracks?.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% topTracks.forEach((track, index) => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="text-truncate">
                  <span class="text-muted"><%= index + 1 %>.</span> <%- escapeHtml(track.track_title) %>
                </div>
                <span class="badge bg-primary rounded-pill"><%= formatNumber(track.count) %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="text-muted text-center my-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm h-100 top-list">
      <div class="card-header fw-semibold"><i class="bi bi-trophy-fill me-2"></i>–¢–æ–ø-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      <div class="card-body">
        <% if (topUsers?.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% topUsers.forEach((user, index) => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="text-truncate">
                  <span class="text-muted"><%= index + 1 %>.</span>
                  <a href="/user/<%= user.id %>" class="text-decoration-none">
                    <%- escapeHtml(user.first_name) || `ID: ${user.id}` %>
                  </a>
                  <% if (user.username) { %>
                    <small class="text-muted">@<%- escapeHtml(user.username) %></small>
                  <% } %>
                </div>
                <span class="badge bg-success rounded-pill"><%= formatNumber(user.total_downloads) %></span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="text-muted text-center my-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        <% } %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm h-100 top-list">
      <div class="card-header fw-semibold"><i class="bi bi-person-plus-fill me-2"></i>–¢–æ–ø-5 —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤</div>
      <div class="card-body">
        <% if (stats.topReferrers?.length > 0) { %>
          <ul class="list-group list-group-flush">
            <% stats.topReferrers.forEach((user, index) => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="text-truncate">
                  <span class="text-muted"><%= index + 1 %>.</span>
                  <a href="/user/<%= user.referrer_id %>" class="text-decoration-none">
                    <%- escapeHtml(user.first_name) || `ID: ${user.referrer_id}` %>
                  </a>
                </div>
                <span class="badge bg-info text-dark rounded-pill">
                  <%= formatNumber(user.referral_count) %> <%= user.referral_count === 1 ? '–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ' : '–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π' %>
                </span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="text-muted text-center my-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%# === –°–∫—Ä–∏–ø—Ç—ã, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ === %>
<%- contentFor('scripts') %>

<%# 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å defer %>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha256-8PzlfscBtTzIlQG6U7a2Yit2V32QxJ33cM3C+zBw8wA=" crossorigin="anonymous" defer></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js" integrity="sha256-0G4+2/h/7Q2nFmgjY/5zY8RWfT/D323Q/i3I0oQue2g=" crossorigin="anonymous" defer></script>

<%# 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –≤—ã–∑–æ–≤–µ—Ç layout.ejs %>
<script>
  window.initializePage = function() {
    console.log('[Dashboard] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...');

    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (typeof Chart === 'undefined' || typeof Litepicker === 'undefined') {
      console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: Chart.js –∏–ª–∏ Litepicker –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –≤–æ–≤—Ä–µ–º—è!');
      document.body.insertAdjacentHTML('afterbegin', '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫. –ì—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è.</div>');
      return;
    }

    // --- Date Picker ---
    const form = document.getElementById('periodForm');
    const startDateInput = document.getElementById('startDateInput');
    const endDateInput = document.getElementById('endDateInput');
    const dateRangePickerElement = document.getElementById('date-range-picker');

    const picker = new Litepicker({
      element: dateRangePickerElement,
      singleMode: false,
      format: 'DD.MM.YYYY',
      startDate: new Date('<%- locals.startDate || new Date(new Date().setDate(new Date().getDate() - 29)).toISOString().slice(0, 10) %>'),
      endDate: new Date('<%- locals.endDate || new Date().toISOString().slice(0, 10) %>'),
      setup: (picker) => {
        picker.on('selected', (date1, date2) => {
          if (date1 && date2) {
            startDateInput.value = date1.format('YYYY-MM-DD');
            endDateInput.value = date2.format('YYYY-MM-DD');
          }
        });
      }
    });
    
    form.querySelectorAll('.btn-group .btn').forEach(button => {
        button.addEventListener('click', (event) => {
            event.preventDefault();
            const days = parseInt(event.target.dataset.days, 10);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - (days - 1));
            
            startDateInput.value = startDate.toISOString().slice(0, 10);
            endDateInput.value = endDate.toISOString().slice(0, 10);
            form.submit();
        });
    });

    if (picker.getStartDate() && picker.getEndDate()) {
        startDateInput.value = picker.getStartDate().format('YYYY-MM-DD');
        endDateInput.value = picker.getEndDate().format('YYYY-MM-DD');
    }

    // --- Chart Drawing ---
    function drawChart(canvasId, chartData, chartType, options = {}) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const container = canvas.parentElement;
        
        if (!chartData?.labels?.length > 0) {
            container.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100 text-muted p-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>`;
            return;
        }

        try {
            if (Chart.getChart(canvas)) {
              Chart.getChart(canvas).destroy();
            }
            new Chart(canvas.getContext('2d'), { 
              type: chartType, 
              data: chartData, 
              options 
            });
        } catch (e) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ ${canvasId}:`, e);
            container.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100 text-danger p-4">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞.</div>`;
        }
    }

    const commonLineBarOptions = { 
        responsive: true, 
        maintainAspectRatio: false, 
        scales: { 
            y: { 
              beginAtZero: true,
              ticks: { 
                  callback: (value) => window.formatNumber ? window.formatNumber(value) : value 
              }
            } 
        },
        plugins: {
            tooltip: {
              callbacks: {
                  label: (context) => `${context.dataset.label}: ${window.formatNumber ? window.formatNumber(context.raw) : context.raw}`
              }
            }
        }
    };

    drawChart('mainChart', <%- JSON.stringify(locals.chartDataCombined || {}) %>, 'line', commonLineBarOptions);
    drawChart('tariffsChart', <%- JSON.stringify(locals.chartDataTariffs || {}) %>, 'doughnut', { 
        responsive: true, 
        maintainAspectRatio: false, 
        plugins: { legend: { position: 'right' } } 
    });
    drawChart('weekdayChart', <%- JSON.stringify(locals.chartDataWeekday || {}) %>, 'bar', { 
      ...commonLineBarOptions, 
      plugins: { 
          ...commonLineBarOptions.plugins,
          legend: { display: false } 
      } 
    });
    drawChart('hourlyChart', <%- JSON.stringify(locals.chartDataHourly || {}) %>, 'bar', { 
      ...commonLineBarOptions, 
      plugins: { 
          ...commonLineBarOptions.plugins,
          legend: { display: false } 
      }
    });

    console.log('[Dashboard] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  };
</script>