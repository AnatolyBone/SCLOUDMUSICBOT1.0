// services/referralManager.js

import { bot } from '../bot.js';
import { setPremium } from '../db.js';

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.
 * @param {object} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç Telegraf.
 */
export async function handleReferralCommand(ctx) {
    const userId = ctx.from.id;
    const botUsername = ctx.botInfo.username;
    const referralLink = `https://t.me/${botUsername}?start=ref_${userId}`;

    const message = `
üôã‚Äç‚ôÇÔ∏è **–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!**

–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–µ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏. –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç–∞ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ **+3 –¥–Ω—è —Ç–∞—Ä–∏—Ñ–∞ Plus**! üéÅ

üîó **–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:**
\`${referralLink}\`

*(–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ—ë)*
    `;

    await ctx.reply(message, { 
        parse_mode: 'Markdown',
        disable_web_page_preview: true 
    });
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–æ–Ω—É—Å—ã.
 * @param {object} newUser - –û–±—ä–µ–∫—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ω–∞—à–µ–π –ë–î.
 * @param {object} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç Telegraf.
 */
export async function processNewUserReferral(newUser, ctx) {
    if (!newUser.referrer_id) {
        return; // –≠—Ç–æ –Ω–µ —Ä–µ—Ñ–µ—Ä–∞–ª, –≤—ã—Ö–æ–¥–∏–º
    }

    console.log(`[Referral] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${newUser.id} –ø—Ä–∏—à–µ–ª –æ—Ç ${newUser.referrer_id}`);
    const referrerId = newUser.referrer_id;

    // 1. –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–º—É
    try {
        // –î–∞–µ–º 3 –¥–Ω—è —Ç–∞—Ä–∏—Ñ–∞ Plus (30 —Å–∫–∞—á–∏–≤–∞–Ω–∏–π/–¥–µ–Ω—å), –¥–æ–±–∞–≤–ª—è—è –∏—Ö –∫ —Ç–µ–∫—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–µ
        await setPremium(referrerId, 30, 3, true); 

        const friendName = ctx.from.first_name || '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        await bot.telegram.sendMessage(
            referrerId,
            `üéâ –í–∞—à –¥—Ä—É–≥ **${friendName}** –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –±–æ—Ç—É –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ!\n\n–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ **+3 –¥–Ω—è —Ç–∞—Ä–∏—Ñ–∞ Plus**. –°–ø–∞—Å–∏–±–æ!`,
            { parse_mode: 'Markdown' }
        );
    } catch (e) {
        console.error(`[Referral] –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å –∏–ª–∏ —É–≤–µ–¥–æ–º–∏—Ç—å ${referrerId}:`, e.message);
    }

    // 2. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–∞–µ–º –±–æ–Ω—É—Å –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try {
        await setPremium(newUser.id, 30, 1); // –î–∞–µ–º 1 –¥–µ–Ω—å —Ç–∞—Ä–∏—Ñ–∞ Plus
        await ctx.reply('üéÅ –í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ –º—ã –¥–∞—Ä–∏–º –≤–∞–º **1 –¥–µ–Ω—å —Ç–∞—Ä–∏—Ñ–∞ Plus**!', { parse_mode: 'Markdown' });
    } catch (e) {
         console.error(`[Referral] –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∏—Å–ª–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å ${newUser.id}:`, e.message);
    }
}