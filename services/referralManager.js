// services/referralManager.js (–§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ò–ú–ü–û–†–¢–ê–ú–ò)

// --- 1. –î–û–ë–ê–í–õ–ï–ù–´ –ù–ï–î–û–°–¢–ê–Æ–©–ò–ï –ò–ú–ü–û–†–¢–´ ---
import { setPremium, getUser, logUserAction } from '../db.js';
import { bot } from '../bot.js';

// --- 2. –¢–í–û–ò –ö–û–ù–°–¢–ê–ù–¢–´ –ò –§–£–ù–ö–¶–ò–ò (–û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---
const REFERRER_BONUS_DAYS = 3;
const NEW_USER_BONUS_DAYS = 3;

export async function handleReferralCommand(ctx) {
    const userId = ctx.from.id;
    const botUsername = ctx.botInfo.username;
    const referralLink = `https://t.me/${botUsername}?start=ref_${userId}`;
    const message = `
üôã‚Äç‚ôÇÔ∏è **–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!**

–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–µ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏. –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å—Ç–∏—Ç –±–æ—Ç–∞ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ **+${REFERRER_BONUS_DAYS} –¥–Ω—è —Ç–∞—Ä–∏—Ñ–∞ Plus**! üéÅ

–í–∞—à –¥—Ä—É–≥ —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å.

üîó **–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:**
\`${referralLink}\`

*(–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ—ë)*
    `;
    await ctx.reply(message, { parse_mode: 'Markdown', disable_web_page_preview: true });
}

export async function processNewUserReferral(newUser, ctx) {
    if (!newUser.referrer_id) {
        return;
    }

    const referrerId = newUser.referrer_id;
    console.log(`[Referral] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${newUser.id} –ø—Ä–∏—à–µ–ª –æ—Ç ${referrerId}. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –±–æ–Ω—É—Å—ã...`);

    try {
        // –ë–æ–Ω—É—Å –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ—Ñ–µ—Ä–∞–ª–∞)
        await setPremium(newUser.id, 30, NEW_USER_BONUS_DAYS);
        await ctx.reply(`üéâ –í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ –º—ã –Ω–∞—á–∏—Å–ª–∏–ª–∏ –≤–∞–º <b>${NEW_USER_BONUS_DAYS} –¥–Ω—è —Ç–∞—Ä–∏—Ñ–∞ Plus!</b>`, { parse_mode: 'HTML' });
        await logUserAction(newUser.id, 'referral_bonus_received', { type: 'new_user' });

        // –ë–æ–Ω—É—Å –¥–ª—è —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª (—Ä–µ—Ñ–µ—Ä–µ—Ä–∞)
        const referrer = await getUser(referrerId);
        if (!referrer) return;

        // "–£–º–Ω–∞—è" –ª–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
        if (referrer.premium_limit > 30) {
            await setPremium(referrer.id, referrer.premium_limit, REFERRER_BONUS_DAYS);
            console.log(`[Referral] –†–µ—Ñ–µ—Ä–µ—Ä ${referrerId} –∏–º–µ–µ—Ç –≤—ã—Å–æ–∫–∏–π —Ç–∞—Ä–∏—Ñ. –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ ${REFERRER_BONUS_DAYS} –¥–Ω—è.`);
            await bot.telegram.sendMessage(
                referrerId,
                `ü•≥ –ü–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!\n\n–í –∫–∞—á–µ—Å—Ç–≤–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –º—ã <b>–ø—Ä–æ–¥–ª–∏–ª–∏ –≤–∞—à—É —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ ${REFERRER_BONUS_DAYS} –¥–Ω—è</b>. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã —Å –Ω–∞–º–∏!`,
                { parse_mode: 'HTML' }
            );
        } else {
            await setPremium(referrer.id, 30, REFERRER_BONUS_DAYS);
            console.log(`[Referral] –†–µ—Ñ–µ—Ä–µ—Ä ${referrerId} –ø–æ–ª—É—á–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞—Ä–∏—Ñ Plus –Ω–∞ ${REFERRER_BONUS_DAYS} –¥–Ω—è.`);
            await bot.telegram.sendMessage(
                referrerId,
                `ü•≥ –ü–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!\n\n–í –∫–∞—á–µ—Å—Ç–≤–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –º—ã –Ω–∞—á–∏—Å–ª–∏–ª–∏ –≤–∞–º <b>${REFERRER_BONUS_DAYS} –¥–Ω—è —Ç–∞—Ä–∏—Ñ–∞ Plus</b>. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã —Å –Ω–∞–º–∏!`,
                { parse_mode: 'HTML' }
            );
        }
        
        await logUserAction(referrerId, 'referral_bonus_received', { type: 'referrer', referred_user_id: newUser.id });

    } catch (e) {
        console.error(`[Referral] –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ –¥–ª—è ${newUser.id} –∏ ${referrerId}:`, e);
    }
}