// config/texts.js (–ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø –° HTML –ò –ù–û–í–´–ú –ü–†–ò–í–ï–¢–°–¢–í–ò–ï–ú)

import { supabase } from '../db.js';

const defaults = {
  // --- –ö–ª—é—á–∏ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∫–æ–º–∞–Ω–¥ ---
  menu: 'üìã –ú–µ–Ω—é',
  upgrade: 'üîì –†–∞—Å—à–∏—Ä–∏—Ç—å –ª–∏–º–∏—Ç',
  mytracks: 'üéµ –ú–æ–∏ —Ç—Ä–µ–∫–∏',
  help: '‚ÑπÔ∏è –ü–æ–º–æ—â—å',

  // --- –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è "—Å—Ç–∞—Ä—ã—Ö" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  start: 'üëã –°–Ω–æ–≤–∞ –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–∫.', 
  
  // –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
  start_new_user: 
    `<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SCloudMusicBot!</b>\n\n` +
    `–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å–∫–∞—á–∞—Ç—å –ª—é–±–∏–º—ã–µ —Ç—Ä–µ–∫–∏ —Å SoundCloud –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP3.\n\n` +
    `<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n` +
    `1. –ù–∞–π–¥–∏—Ç–µ —Ç—Ä–µ–∫ –Ω–∞ SoundCloud.\n` +
    `2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞ –Ω–µ–≥–æ —Å—Å—ã–ª–∫—É.\n` +
    `3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –º–Ω–µ –≤ —á–∞—Ç.\n\n` +
    `üëá –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É.`,

  // –¢–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–∞—Ä–∏—Ñ–∞—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ HTML
  upgradeInfo:
    `<b>üöÄ –•–æ—á–µ—à—å –±–æ–ª—å—à–µ —Ç—Ä–µ–∫–æ–≤?</b>\n\n` +
    `<b>üÜì Free</b> ‚Äî 5 üü¢\n` +
    `<b>üéØ Plus</b> ‚Äî 30 (119‚ÇΩ)\n` +
    `<b>üí™ Pro</b> ‚Äî 100 (199‚ÇΩ)\n` +
    `<b>üíé Unlimited</b> ‚Äî –±–µ–∑–ª–∏–º–∏—Ç (299‚ÇΩ)\n\n` +
    `üëâ –î–æ–Ω–∞—Ç: <a href="https://boosty.to/anatoly_bone/donate">boosty.to/anatoly_bone/donate</a>\n` +
    `‚úâÔ∏è –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–ø–∏—à–∏: @anatolybone\n\n` +
    `üì£ –ù–æ–≤–æ—Å—Ç–∏ –∏ —Ñ–∏—à–∫–∏: @SCMBLOG`,

  // –¢–µ–∫—Å—Ç –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "–ü–æ–º–æ—â—å"
  helpInfo:
    '‚ÑπÔ∏è –ü—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É ‚Äî –ø–æ–ª—É—á–∏—à—å mp3.\n' +
    'üîì ¬´–†–∞—Å—à–∏—Ä–∏—Ç—å¬ª ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö.\n' +
    'üéµ ¬´–ú–æ–∏ —Ç—Ä–µ–∫–∏¬ª ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\n' +
    'üì£ –ö–∞–Ω–∞–ª: @SCM_BLOG',

  // --- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ---
  error: '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.',
  noTracks: '–í—ã –µ—â–µ –Ω–µ —Å–∫–∞—á–∏–≤–∞–ª–∏ —Ç—Ä–µ–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è.',
  limitReached: 'üö´ –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∑–∞–≥—Ä—É–∑–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω.\n\n{bonus_message}üí° –ß—Ç–æ–±—ã —Å–∫–∞—á–∏–≤–∞—Ç—å –±–æ–ª—å—à–µ, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–Ω–æ–ø–∫–æ–π ¬´–†–∞—Å—à–∏—Ä–∏—Ç—å –ª–∏–º–∏—Ç¬ª.',
  blockedMessage: '‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.',
};

// --- –õ–û–ì–ò–ö–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ò (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

let cache = { ...defaults };
let lastLoad = 0;
const TTL_MS = 60 * 1000; // –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ –º–∏–Ω—É—Ç—É

export async function loadTexts(force = false) {
  const now = Date.now();
  if (!force && now - lastLoad < TTL_MS) return cache;

  try {
    const { data, error } = await supabase.from('bot_texts').select('key,value');
    if (error) {
      console.error('[texts] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Supabase:', error.message);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à/–¥–µ—Ñ–æ–ª—Ç—ã
      return cache;
    }

    const map = { ...defaults };
    for (const row of data || []) {
      if (row?.key && typeof row.value === 'string') map[row.key] = row.value;
    }

    cache = map;
    lastLoad = now;

  } catch (e) {
    console.error('[texts] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–∫—Å—Ç–æ–≤:', e.message);
  }

  return cache;
}

export function T(key) {
  return cache[key] ?? defaults[key] ?? '';
}

export function allTextsSync() {
  return { ...cache };
}

export async function setText(key, value) {
  if (!key) throw new Error('key is required');
  const { error } = await supabase
    .from('bot_texts')
    .upsert({ key, value }, { onConflict: 'key' });
  if (error) throw new Error(error.message);
  cache[key] = value;
  lastLoad = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∫—ç—à–∞, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ —Ç–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ
  return true;
}