// config/texts.js (–ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø –° HTML –ò –ù–û–í–´–ú –ü–†–ò–í–ï–¢–°–¢–í–ò–ï–ú)

import { supabase } from '../db.js';

// config/texts.js

// –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï–õ–¨–ó–Ø —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ, —Ç.–∫. –Ω–∞ –Ω–∏—Ö –∑–∞–≤—è–∑–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ bot.hears()
const systemKeys = {
  menu: 'üìã –ú–µ–Ω—é',
  upgrade: 'üîì –†–∞—Å—à–∏—Ä–∏—Ç—å –ª–∏–º–∏—Ç',
  mytracks: 'üéµ –ú–æ–∏ —Ç—Ä–µ–∫–∏',
  help: '‚ÑπÔ∏è –ü–æ–º–æ—â—å',
};

// –¢–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ú–û–ñ–ù–û —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ
const editableTexts = {
  start: 'üëã –°–Ω–æ–≤–∞ –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü—Ä–∏—à–ª–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–∫.', 

  start_new_user: 
    `<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SCloudMusicBot!</b>\n\n` +
    `–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å–∫–∞—á–∞—Ç—å –ª—é–±–∏–º—ã–µ —Ç—Ä–µ–∫–∏ –∏ <b>–ø–ª–µ–π–ª–∏—Å—Ç—ã</b> —Å SoundCloud –≤ MP3.\n\n` +
    `<b>–ú–æ–∏ –≥–ª–∞–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n\n` +
    `üì• <b>1. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ</b>\n` +
    `–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–∫ –∏–ª–∏ —Ü–µ–ª—ã–π –ø–ª–µ–π–ª–∏—Å—Ç, –∏ —è –Ω–∞—á–Ω—É –∑–∞–≥—Ä—É–∑–∫—É.\n\n` +
    `üîé <b>2. –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏ –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ</b>\n` +
    `–í –ª—é–±–æ–º –¥—Ä—É–≥–æ–º —á–∞—Ç–µ (–∏–ª–∏ –∑–¥–µ—Å—å) –Ω–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å <code>@SCloudMusicBot</code> –∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞. –í—ã —Å–º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º—É–∑—ã–∫—É, –Ω–µ –≤—ã—Ö–æ–¥—è –∏–∑ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –≤ –ª—é–±–æ–º —á–∞—Ç–µ!`,

  upgradeInfo:
    `<b>üöÄ –•–æ—á–µ—à—å –±–æ–ª—å—à–µ —Ç—Ä–µ–∫–æ–≤?</b>\n\n` +
    `<b>üÜì Free</b> ‚Äî 5 üü¢\n` +
    `<b>üéØ Plus</b> ‚Äî 30 (119‚ÇΩ)\n` +
    `<b>üí™ Pro</b> ‚Äî 100 (199‚ÇΩ)\n` +
    `<b>üíé Unlimited</b> ‚Äî –±–µ–∑–ª–∏–º–∏—Ç (299‚ÇΩ)\n\n` +
    `üëâ –î–æ–Ω–∞—Ç: <a href="https://boosty.to/anatoly_bone/donate">boosty.to/anatoly_bone/donate</a>\n` +
    `‚úâÔ∏è –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–ø–∏—à–∏: @anatolybone\n\n` +
    `üì£ –ù–æ–≤–æ—Å—Ç–∏ –∏ —Ñ–∏—à–∫–∏: @SCMBLOG`,

  helpInfo:
    '‚ÑπÔ∏è –ü—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É ‚Äî –ø–æ–ª—É—á–∏—à—å mp3.\n' +
    'üîì ¬´–†–∞—Å—à–∏—Ä–∏—Ç—å¬ª ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö.\n' +
    'üéµ ¬´–ú–æ–∏ —Ç—Ä–µ–∫–∏¬ª ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\n' +
    'üì£ –ö–∞–Ω–∞–ª: @SCM_BLOG',

  error: '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.',
  noTracks: '–í—ã –µ—â–µ –Ω–µ —Å–∫–∞—á–∏–≤–∞–ª–∏ —Ç—Ä–µ–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è.',
  limitReached: 'üö´ –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∑–∞–≥—Ä—É–∑–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω.\n\n{bonus_message}üí° –ß—Ç–æ–±—ã —Å–∫–∞—á–∏–≤–∞—Ç—å –±–æ–ª—å—à–µ, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–Ω–æ–ø–∫–æ–π ¬´–†–∞—Å—à–∏—Ä–∏—Ç—å –ª–∏–º–∏—Ç¬ª.',
  blockedMessage: '‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.',
};

// –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏—Ö –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏
const defaults = { ...systemKeys, ...editableTexts };

// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —ç–∫—Å–ø–æ—Ä—Ç-—Ñ—É–Ω–∫—Ü–∏—é
export function getEditableTexts() {
    const currentTexts = allTextsSync();
    const result = {};
    for (const key in editableTexts) {
        result[key] = currentTexts[key] ?? editableTexts[key];
    }
    return result;
}

// --- –õ–û–ì–ò–ö–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ò (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
// ... (–≤–µ—Å—å –≤–∞—à –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ–∞–π–ª–∞ texts.js)

let cache = { ...defaults };
let lastLoad = 0;
const TTL_MS = 60 * 1000; // –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ –º–∏–Ω—É—Ç—É

export async function loadTexts(force = false) {
  const now = Date.now();
  if (!force && now - lastLoad < TTL_MS) return cache;

  try {
    const { data, error } = await supabase.from('bot_texts').select('key,value');
    if (error) {
      console.error('[texts] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Supabase:', error.message);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à/–¥–µ—Ñ–æ–ª—Ç—ã
      return cache;
    }

    const map = { ...defaults };
    for (const row of data || []) {
      if (row?.key && typeof row.value === 'string') map[row.key] = row.value;
    }

    cache = map;
    lastLoad = now;

  } catch (e) {
    console.error('[texts] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ–∫—Å—Ç–æ–≤:', e.message);
  }

  return cache;
}

export function T(key) {
  return cache[key] ?? defaults[key] ?? '';
}

export function allTextsSync() {
  return { ...cache };
}

export async function setText(key, value) {
  if (!key) throw new Error('key is required');
  const { error } = await supabase
    .from('bot_texts')
    .upsert({ key, value }, { onConflict: 'key' });
  if (error) throw new Error(error.message);
  cache[key] = value;
  lastLoad = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∫—ç—à–∞, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ —Ç–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ
  return true;
}